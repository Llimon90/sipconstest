<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de ventas</title>
  <link rel="stylesheet" href="../css/styles.css?v=9">
</head>


<body>
  <div class="retorna" >
    <a href="../index.html">  <<- Inicio</a>  </div>

  <!-- Panel lateral  -->
  <aside class="sidebar">
    
    <ul>
      <li><a href="../index.html">Inicio</a></li>
      <li><a href="incidencias.html">Incidencias</a></li>
      <li><a href="reportes.html">Buscar incidencias</a></li>
      <li><a href="clientes.html">Clientes</a></li>
      <li><a href="usuarios.html">Usuarios</a></li>
      <li><a href="#">Configuración</a></li>
    </ul>

  </aside>
  <section class="encabezado">
    <main>
      <form id="form-venta">
        <!-- Cliente y Sucursal -->
        <div class="form-row">
          <div><label for="cliente">Cliente</label> <select id="cliente" name="cliente" required><option value="" selected disabled>Seleccione una opción</option></select></div>
          <div><label for="sucursal">Sucursal:</label><input type="text" id="sucursal" name="sucursal"></div>
        </div>

        <!-- Equipo y Marca -->
        <div class="form-row">
          <div><label for="equipo">Equipo:</label><input type="text" id="equipo" name="equipo" ></div>
          <div><label for="marca">Marca:</label><input type="text" id="marca" name="marca"></div>
        </div>

        <!-- Modelo -->
        <div class="form-row">
            <div><label for="modelo">Modelo:</label><input type="text" id="modelo" name="modelo"></div>

        </div>

        </div>

        <!-- Cantidad y Número(s) de Serie -->
        <div class="form-row" style="display: flex; text-align: center;">
            <div><label for="qty">Cantidad:</label><input type="number" id="qty" name="qty" min="1" value="1" required></div>
            <div><label for="garantia">Garantía (meses):</label> <input type="number" id="garantia" name="garantia" min="0" ></div>
            <div><label for="calibracion">Sugerir calibración  en (meses):</label> <input type="number" id="calibracion" name="calibracion" min="0" ></div>
            <div><label for="servicio">Cláusula de servicio:</label><input type="checkbox" id="servicio" name="servicio"></div>
        </div>

        <!-- Aquí se insertan dinámicamente los inputs de serie -->
        <div id="series-container"></div>
        
        

          


        <!-- Notas -->
        <div class="form-row">
          <div>
            <label for="notas">Notas:</label>
            <textarea id="notas" name="notas"></textarea>
          </div>
        </div>

        <!-- Botón registrar venta -->
        <div class="form-row">
          <button type="button" id="btn-registrar-venta">Registrar Venta</button>
        </div>
      </form>

      <div id="mensaje"></div>
    </main>
  </section>

  <script src="../scripts/registro_venta.js?v=33" defer></script>



  <!-- Sección de Búsqueda de Ventas -->
<section id="busqueda-ventas" class="my-5">
    <div class="container">
        <h2 class="mb-4">Búsqueda de Ventas</h2>
        
        <!-- Formulario de Búsqueda -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Filtros de Búsqueda</h5>
            </div>
            <div class="card-body">
                <form id="form-busqueda-ventas">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="cliente" class="form-label">Cliente</label>
                            <input type="text" class="form-control" id="cliente" placeholder="Nombre del cliente">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="serie" class="form-label">Número de Serie</label>
                            <input type="text" class="form-control" id="serie" placeholder="Número de serie del equipo">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fecha-venta" class="form-label">Fecha de Venta</label>
                            <input type="date" class="form-control" id="fecha-venta">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="sucursal" class="form-label">Sucursal</label>
                            <select class="form-select" id="sucursal">
                                <option value="" selected>Todas las sucursales</option>
                                <option value="1">Sucursal Norte</option>
                                <option value="2">Sucursal Sur</option>
                                <option value="3">Sucursal Centro</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="equipo" class="form-label">Equipo</label>
                            <input type="text" class="form-control" id="equipo" placeholder="Tipo de equipo">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="marca" class="form-label">Marca</label>
                            <input type="text" class="form-control" id="marca" placeholder="Marca del equipo">
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="reset" class="btn btn-secondary me-2">Limpiar</button>
                        <button type="submit" class="btn btn-primary">Buscar</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Resultados de Búsqueda -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Resultados</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tabla-ventas" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID Venta</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Equipo</th>
                                <th>Marca</th>
                                <th>N° Serie</th>
                                <th>Sucursal</th>
                                <th>Total</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los resultados se cargarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal para Edición de Venta -->
<div class="modal fade" id="modal-editar-venta" tabindex="-1" aria-labelledby="modal-editar-venta-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modal-editar-venta-label">Editar Venta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-editar-venta">
                    <input type="hidden" id="venta-id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-fecha" class="form-label">Fecha de Venta</label>
                            <input type="date" class="form-control" id="edit-fecha" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-cliente" class="form-label">Cliente</label>
                            <input type="text" class="form-control" id="edit-cliente" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-equipo" class="form-label">Equipo</label>
                            <input type="text" class="form-control" id="edit-equipo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-marca" class="form-label">Marca</label>
                            <input type="text" class="form-control" id="edit-marca" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-serie" class="form-label">Número de Serie</label>
                            <input type="text" class="form-control" id="edit-serie" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-sucursal" class="form-label">Sucursal</label>
                            <select class="form-select" id="edit-sucursal" required>
                                <option value="1">Sucursal Norte</option>
                                <option value="2">Sucursal Sur</option>
                                <option value="3">Sucursal Centro</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-total" class="form-label">Total</label>
                            <input type="number" step="0.01" class="form-control" id="edit-total" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-estado" class="form-label">Estado</label>
                            <select class="form-select" id="edit-estado" required>
                                <option value="completada">Completada</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-notas" class="form-label">Notas Adicionales</label>
                        <textarea class="form-control" id="edit-notas" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-eliminar-venta">Eliminar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar-cambios">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para la funcionalidad -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    let ventasData = [];
    
    // Evento para enviar el formulario de búsqueda
    document.getElementById('form-busqueda-ventas').addEventListener('submit', function(e) {
        e.preventDefault();
        buscarVentas();
    });
    
    // Función para buscar ventas (simulada)
    function buscarVentas() {
        // Aquí normalmente harías una petición AJAX a tu backend
        // Esto es solo un ejemplo con datos simulados
        const filtros = {
            cliente: document.getElementById('cliente').value,
            serie: document.getElementById('serie').value,
            fecha: document.getElementById('fecha-venta').value,
            sucursal: document.getElementById('sucursal').value,
            equipo: document.getElementById('equipo').value,
            marca: document.getElementById('marca').value
        };
        
        // Simular respuesta del servidor
        ventasData = [
            {
                id: 1,
                fecha: '2023-05-15',
                cliente: 'Juan Pérez',
                equipo: 'Laptop',
                marca: 'HP',
                serie: 'SN123456',
                sucursal: 'Sucursal Norte',
                total: 1250.99,
                estado: 'completada',
                notas: 'Cliente satisfecho'
            },
            {
                id: 2,
                fecha: '2023-05-16',
                cliente: 'María García',
                equipo: 'Impresora',
                marca: 'Epson',
                serie: 'SN789012',
                sucursal: 'Sucursal Sur',
                total: 350.50,
                estado: 'pendiente',
                notas: 'Entrega pendiente'
            }
        ];
        
        mostrarResultados(ventasData);
    }
    
    // Función para mostrar resultados en la tabla
    function mostrarResultados(ventas) {
        const tbody = document.querySelector('#tabla-ventas tbody');
        tbody.innerHTML = '';
        
        ventas.forEach(venta => {
            const tr = document.createElement('tr');
            tr.dataset.id = venta.id;
            tr.innerHTML = `
                <td>${venta.id}</td>
                <td>${venta.fecha}</td>
                <td>${venta.cliente}</td>
                <td>${venta.equipo}</td>
                <td>${venta.marca}</td>
                <td>${venta.serie}</td>
                <td>${venta.sucursal}</td>
                <td>$${venta.total.toFixed(2)}</td>
                <td><span class="badge ${getEstadoBadgeClass(venta.estado)}">${venta.estado}</span></td>
            `;
            
            // Agregar evento de clic a la fila
            tr.addEventListener('click', function() {
                cargarDatosModal(venta);
                const modal = new bootstrap.Modal(document.getElementById('modal-editar-venta'));
                modal.show();
            });
            
            tbody.appendChild(tr);
        });
    }
    
    // Función para obtener clase CSS según estado
    function getEstadoBadgeClass(estado) {
        switch(estado) {
            case 'completada': return 'bg-success';
            case 'pendiente': return 'bg-warning text-dark';
            case 'cancelada': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    // Función para cargar datos en el modal
    function cargarDatosModal(venta) {
        document.getElementById('venta-id').value = venta.id;
        document.getElementById('edit-fecha').value = venta.fecha;
        document.getElementById('edit-cliente').value = venta.cliente;
        document.getElementById('edit-equipo').value = venta.equipo;
        document.getElementById('edit-marca').value = venta.marca;
        document.getElementById('edit-serie').value = venta.serie;
        document.getElementById('edit-sucursal').value = venta.sucursal === 'Sucursal Norte' ? '1' : 
                                                      venta.sucursal === 'Sucursal Sur' ? '2' : '3';
        document.getElementById('edit-total').value = venta.total;
        document.getElementById('edit-estado').value = venta.estado;
        document.getElementById('edit-notas').value = venta.notas || '';
    }
    
    // Evento para guardar cambios
    document.getElementById('btn-guardar-cambios').addEventListener('click', function() {
        const ventaId = document.getElementById('venta-id').value;
        const datosActualizados = {
            fecha: document.getElementById('edit-fecha').value,
            cliente: document.getElementById('edit-cliente').value,
            equipo: document.getElementById('edit-equipo').value,
            marca: document.getElementById('edit-marca').value,
            serie: document.getElementById('edit-serie').value,
            sucursal: document.getElementById('edit-sucursal').value,
            total: parseFloat(document.getElementById('edit-total').value),
            estado: document.getElementById('edit-estado').value,
            notas: document.getElementById('edit-notas').value
        };
        
        // Aquí normalmente harías una petición AJAX para actualizar en la BD
        console.log('Actualizando venta ID:', ventaId, 'con datos:', datosActualizados);
        
        // Simular actualización
        const ventaIndex = ventasData.findIndex(v => v.id == ventaId);
        if (ventaIndex !== -1) {
            ventasData[ventaIndex] = {
                ...ventasData[ventaIndex],
                ...datosActualizados,
                sucursal: document.getElementById('edit-sucursal').options[document.getElementById('edit-sucursal').selectedIndex].text
            };
            
            mostrarResultados(ventasData);
        }
        
        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('modal-editar-venta')).hide();
    });
    
    // Evento para eliminar venta
    document.getElementById('btn-eliminar-venta').addEventListener('click', function() {
        const ventaId = document.getElementById('venta-id').value;
        
        if (confirm('¿Estás seguro de que deseas eliminar esta venta?')) {
            // Aquí normalmente harías una petición AJAX para eliminar en la BD
            console.log('Eliminando venta ID:', ventaId);
            
            // Simular eliminación
            ventasData = ventasData.filter(v => v.id != ventaId);
            mostrarResultados(ventasData);
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('modal-editar-venta')).hide();
        }
    });
});
</script>

<!-- Estilos adicionales -->
<style>
    #tabla-ventas tbody tr {
        cursor: pointer;
    }
    #tabla-ventas tbody tr:hover {
        background-color: #f8f9fa;
    }
    .badge {
        font-size: 0.9em;
    }
</style>
</body>
</html>
